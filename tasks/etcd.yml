---
- set_fact:
    etcd_package: etcd
  when: ansible_distribution_release == "xenial"

- set_fact:
    etcd_package: etcd=2.3.7+dfsg-5
  when: ansible_distribution_release == "stretch"

- set_fact:
    etcd_package: etcd-server
  when: ((ansible_distribution_release != "stretch") and (ansible_distribution_release != "xenial"))

- name: check if package {{ etcd_package }} is installed
  shell: dpkg-query -W -f='${Status}' {{ etcd_package }} | grep 'install ok installed'
  failed_when:  no  # don't ever fail
  changed_when: no  # doesn't ever change anything
  check_mode:   no  # run in check mode
  register: package_is_installed

# coupled to task "unmask etcd" below
#
# This is task ensures that etcd doesn't start and does not
# setup state for the the "default" cluster. We want to set
# up the cluster first and then start it, so it initializes 
# correctly with all peers.
#
- name: make sure etcd is not started on first install
  systemd:
    name: etcd
    masked: yes
  when: package_is_installed.rc != 0

- name: Install {{ etcd_package }} package
  apt:
    pkg: "{{ etcd_package }}"

- name: Setup snapshot repository
  apt_repository:
    repo: 'deb [check-valid-until=no] http://snapshot.debian.org/archive/debian/20161015T102332Z/ testing main'
    filename: 'snapshot'
    update_cache: true
  when: (ansible_distribution_release == "stretch")

- name: Set member name
  lineinfile:
    dest: "/etc/default/etcd"
    line: "ETCD_NAME=\"{{ ansible_hostname }}\""
    regexp: ".*ETCD_NAME.*"
  notify: restart etcd
  tags:
    - config

- name: Listen for other cluster peers
  lineinfile:
    dest: "/etc/default/etcd"
    line: "ETCD_LISTEN_PEER_URLS=\"http://{{ hostvars[ansible_hostname]['ansible_eth0']['ipv4']['address'] }}:2380\""
    regexp: ".*ETCD_LISTEN_PEER_URLS.*"
  notify: restart etcd
  tags:
    - config

- name: Setup advertised peer communication URL
  lineinfile:
    dest: "/etc/default/etcd"
    line: "ETCD_INITIAL_ADVERTISE_PEER_URLS=\"http://{{ hostvars[ansible_hostname]['ansible_eth0']['ipv4']['address'] }}:2380\""
    regexp: ".*ETCD_INITIAL_ADVERTISE_PEER_URLS.*"
  notify: restart etcd
  tags:
    - config

- name: Enable client listen interface
  lineinfile:
    dest: "/etc/default/etcd"
    line: "ETCD_LISTEN_CLIENT_URLS=\"http://localhost:2379,http://{{ hostvars[ansible_hostname]['ansible_eth0']['ipv4']['address'] }}:2379\""
    regexp: ".*ETCD_LISTEN_CLIENT_URLS.*"
  notify: restart etcd
  tags:
    - config

# ugly! Is there a better way?
- name: Advertise client interface
  lineinfile:
    dest: "/etc/default/etcd"
    line: "ETCD_ADVERTISE_CLIENT_URLS=\"{% for ip in dcs_ips %}http://{{ ip }}:2379{% if not loop.last %},{% endif %}{% endfor %}\""
    regexp: ".*ETCD_ADVERTISE_CLIENT_URLS.*"
  notify: restart etcd
  tags:
    - config

# ugly! Is there a better way?
- name: Setup URLs of initials members
  lineinfile:
    dest: "/etc/default/etcd"
    line: "ETCD_INITIAL_CLUSTER=\"{% for host in groups['dcs_servers'] %}{{ host }}=http://{{ hostvars[host]['ansible_eth0']['ipv4']['address'] }}:2380{% if not loop.last %},{% endif %}{% endfor %}\""
    regexp: ".*ETCD_INITIAL_CLUSTER.*"
  notify: restart etcd
  tags:
    - config

# linked to task "make sure etcd is not started on first install" above
- name: unmask etcd
  systemd:
    name: etcd
    masked: no

- name: make sure etcd is running
  systemd:
    name: etcd
    state: started
    enabled: yes
