- name: Install etcd-client
  apt: pkg=etcd-client

- name: Check if /etc/bash_completion.d exists
  stat: path=/etc/bash_completion.d
  register: etc_bash_completion_d

- name: Add bash completions for etcd
  copy: src=bash_completion/etcdctl dest=/etc/bash_completion.d
  when: etc_bash_completion_d.stat.exists

# it seems like our current setup is only v2 compatible, so
# use v2 client settings for the time being
#
- name: Configure etcdctl settings
  lineinfile:
    dest: "/root/.bashrc"
    # v3
    # line: 'export ETCDCTL_API=3; export ETCDCTL_CACERT=/etc/patroni/certificates/ca.cert.pem; export ETCDCTL_CERT=/etc/patroni/certificates/{{ ansible_hostname }}.cert.pem; export ETCDCTL_KEY=/etc/patroni/certificates/{{ ansible_hostname }}.key.pem; export ETCDCTL_ENDPOINTS="{{ etcd_proto }}://{{ etcd_host_ip }}:2379,http://{{ etcd_host_ip }}:4001"'
    line: 'export ETCDCTL_API=2; export ETCDCTL_CA_FILE=/etc/patroni/certificates/ca.cert.pem; export ETCDCTL_CERT_FILE=/etc/patroni/certificates/{{ ansible_hostname }}.cert.pem; export ETCDCTL_KEY_FILE=/etc/patroni/certificates/{{ ansible_hostname }}.key.pem; export ETCDCTL_ENDPOINT="{{ etcd_proto }}://{{ etcd_host_ip }}:2379,http://{{ etcd_host_ip }}:4001"'
    regexp: "^export ETCDCTL_API="
  when: use_certificates
